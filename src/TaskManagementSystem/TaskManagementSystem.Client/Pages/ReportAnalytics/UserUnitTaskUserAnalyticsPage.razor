@page "/user-unit-analytics"
@attribute [Authorize]

<PageTitle>User / Unit Assigned Tasks Analytics</PageTitle>

<TaskManagementSystem.Client.SharedContent.LoadingSpinner IsVisible="!_isFormInitialized" DisplayMessage="Fetching Analytics Filter Details......." />

<div class="d-flex flex-column w-100">

    <h3 class="mb-3">User / Unit Task Analytics</h3>

    @if(_parameter is not null)
    {
        <div class="d-flex flex-row gap-3 justify-content-between align-items-center flex-wrap w-100">

            <div class="d-flex flex-column gap-1 flex-wrap">
                <label class="form-label fw-bold text-primary">Start Date</label>
                <input class="form-control" type="date" required @bind="_parameter.StartDate" />
            </div>

            <div class="d-flex flex-column gap-1 flex-wrap">
                <label class="form-label fw-bold text-primary">End Date</label>
                <input class="form-control" type="date" required @bind="_parameter.EndDate" />
            </div>

            @if (_availableUnits is not null && _availableUnits.Any())
            {
                <div class="d-flex flex-column gap-1 flex-wrap">
                    <label class="form-label fw-bold text-primary">Unit</label>
                    <select class="form-select" @bind="_parameter.UnitId">
                        <option value=""></option>
                        @foreach (var unit in _availableUnits)
                        {
                            <option value="@unit.Id">@unit.Name</option>
                        }
                    </select>
                </div>
            }

            @if (_availableUsers is not null && _availableUsers.Any())
            {
                <div class="d-flex flex-column gap-1 flex-wrap">
                    <label class="form-label fw-bold text-primary">User</label>
                    <select class="form-select" @bind="_parameter.UserId">
                        <option value=""></option>
                        @foreach (var user in _availableUsers)
                        {
                            <option value="@user.Id">@user.FullName</option>
                        }
                    </select>
                </div>
            }

            <div class="d-flex flex-column align-items-center justify-content-center">
                <button class="btn btn-primary" type="button" @onclick="GetReportAnalytics">
                    Get Analytics Report
                </button>
            </div>

        </div>

        <TaskManagementSystem.Client.SharedContent.LoadingSpinner IsVisible="_isLoading" />

        @if (_responseMessage is not null)
        {
            if (_reportAnalytics is not null && _reportAnalytics.Any())
            {
                <div class="d-flex w-100 justify-content-center align-items-center mt-3 p-0">
                    <UserUnitTaskUserAnalyticsView UserUnitAnalytics="_reportAnalytics" HandleShowDetails="HandleShowDetails" />
                </div>
            }
            else
            {
                <p class="text-muted mt-3 mt-lg-2 fs-5 fst-italic text-center text-wrap fw-bold text-primary">No analytics data available for selected criteria.</p>
            }
        }
    }
</div>

<TaskManagementSystem.Client.SharedContent.Popup @ref="popup" ShowCloseButton="true" Title="User Analytics Card" SaveChanges="HandleClose">
    <Body>
        @if(_operationToPerform == OperationType.ShowDetails)
        {
            <UserTaskAnalyticsSummaryCard UserAnalytics="@_selectedAnalytics" />
        }
    </Body>
</TaskManagementSystem.Client.SharedContent.Popup>

@code {
    //OPERATION VARIABLES
    private bool _isLoading;
    private bool _isFormInitialized = false;
    private TaskManagementSystem.Client.SharedContent.Popup popup;
    private UserUnitAssignedUserTaskAnalyticsDto _selectedAnalytics;
    private OperationType _operationToPerform;

    //OPERATION PARAMETER VARIABLES
    private UserUnitTaskUserAnalyticsRequestParameter _parameter;
    private List<UnitDto> _availableUnits;
    private List<UserSummaryDto> _availableUsers;
    private string _responseMessage;
    private bool _isSuccessful;
    private IEnumerable<UserUnitAssignedUserTaskAnalyticsDto> _reportAnalytics;

    protected override async Task OnInitializedAsync()
    {
        var getUnit = getUnitsHandler.Handle();
        var getUser = getUserSummaryDetailsHandler.Handle();

        await Task.WhenAll(getUnit, getUser);

        _availableUnits = (getUnit.Result).ToList();
        _availableUsers = (getUser.Result).ToList();

        _parameter = new() { StartDate = DateOnly.FromDateTime(DateTime.Now.AddDays(-7)), EndDate = DateOnly.FromDateTime(DateTime.Now) };

        _isFormInitialized = true;
    }

    private async Task GetReportAnalytics()
    {
        _isLoading = true;

        try
        {
            var response = await getUserUnitTaskUserAnalyticsHandler.Handle(_parameter);

            _reportAnalytics = response?.Data ?? [];
            _isSuccessful = response.IsSuccessful;
            _responseMessage = response.Message;
        }
        catch (Exception ex)
        {
            _responseMessage = $"Error: {ex.Message}";
            _isSuccessful = false;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void HandleShowDetails(UserUnitAssignedUserTaskAnalyticsDto selectedAnalytics)
    {
        _selectedAnalytics = selectedAnalytics;
        _operationToPerform = OperationType.ShowDetails;
        popup.Open();
    }

    private void HandleClose()
    {
        _selectedAnalytics = null;
        _operationToPerform = default;
    }
}

@code{
    enum OperationType
    {
        None,
        ShowDetails
    }
}
