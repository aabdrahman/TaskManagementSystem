@page "/tasks/edit/{TaskId}"
@attribute [Authorize(Roles = "BUSINESSANALYST,PRODUCTOWNER")]

@inject AuthenticationStateProvider authStateProvider

<PageTitle>Edit Created Task - @TaskId</PageTitle>

<div class="d-flex flex-row justify-content-between">
    <h2>
        Edit Created Task - @TaskId
    </h2>
    <button class="btn btn-primary" tyoe="button" @onclick="HandleNavigateToList">
        Go to Tasks List
    </button>
</div>

<hr style="height:30px;color:black;" />

@if (_taskToUpdate is null && _fetchTaskToUpdateSuccessStatus)
{
    <div class="no-trails" style="text-align:center;margin-top:100px;">
        <svg viewBox="0 0 16 16" class="bi bi-tree" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:200px;">
            <path fill-rule="evenodd" d="M8 0a.5.5 0 0 1 .416.223l3 4.5A.5.50 0 1 11 5.5h-.098l2.022 3.235a.5.5 0 0 1-.424.765h-.191l1.638 3.276a.5.50 0 1-.447.724h-11a.5.5 0 0 1-.447-.724L3.69 9.5H3.5a.5.5 0 01-.424-.765L5.098 5.5H5a.5.5 0 0 1-.416-.777l3-4.5A.5.5 0 0 1 8 0zM5.9344.5H6a.5.5 0 0 1 .424.765L4.402 8.5H4.5a.5.5 0 0 1 .447.724L3.3112.5h9.382l-1.638-3.276A.5.5 0 0 1 11.5 8.5h.098L9.576 5.265A.5.5 0 0 110 4.5h.066L8 1.401 5.934 4.5z" />
            <path d="M7 13.5h2V16H7v-2.5z" />
        </svg>
        <h3 class="text-muted fw-light">
            Task could not be fetched.
        </h3>
    </div>
}

@if(_editContext is not null)
{
    <div class="container-fluid container-xxl">
        <div class="row">
            <div class="col-1">
            </div>
            <div class="col-10">
                <div class="d-flex flex-column gap-2 justify-content-center align-iitems-center">
                    @if(_responseMessage is not null && !_isLoading)
                    {
                        <div class="alert fst-italic text-center fs-6 fw-bold alert-@(_isSuccessful ? "success" : "danger")" role="alert">
                            @(_isSuccessful ? $"{_responseMessage}" : _responseMessage)
                        </div>
                    }
                    <EditForm EditContext="_editContext" OnValidSubmit="OnHandleSubmit" class="w-100">
                        <DataAnnotationsValidator />
                        <div class="form-group d-flex mb-2 flex-column">
                            <label class="form-label fw-bolder" for="update-task-title">Title</label>
                            <InputText class="form-control" @bind-Value="_updateCreatedTaskModel.Title" id="update-task-title" placeholder="Task title" />
                            <ValidationMessage For="(() => _updateCreatedTaskModel.Title)" />
                        </div>
                        <div class="form-group d-flex mb-2 flex-column">
                            <label class="form-label fw-bolder" for="update-task-description">Description</label>
                            <InputTextArea class="form-control" @bind-Value="_updateCreatedTaskModel.Description" id="update-task-description" placeholder="Task Description" />
                            <ValidationMessage For="(() => _updateCreatedTaskModel.Description)" />
                        </div>
                        <div class="d-flex flex-row mb-2 justify-content-between gap-2">
                            <div class="form-group d-flex flex-column w-50">
                                <label for="update-task-priority" class="form-label fw-bold">Priority</label>
                                <InputSelect class="form-select" id="update-task-priority" @bind-Value="_updateCreatedTaskModel.Priority">
                                    <option selected value="0"></option>
                                    @foreach (var item in Enum.GetValues(typeof(Entities.StaticValues.PriorityLevel)))
                                    {
                                        <option value="@item.ToString()">@item.ToString()</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="(() => _updateCreatedTaskModel.Priority)" />
                            </div>
                            <div class="d-flex flex-column w-50 form-group">
                                <label class="form-label fw-bold" for="update-task-priority">Expected Delivery Date</label>
                                <InputDate class="form-control" id="update-task-priority" @bind-Value="_updateCreatedTaskModel.ProposedCompletionDate" />
                                <ValidationMessage For="(() => _updateCreatedTaskModel.ProposedCompletionDate)" />
                            </div>
                        </div>
                        <div class="d-flex flex-row justify-content-between">
                            @*
                                <button class="btn btn-secondary" type="button" @onclick="ResetForm">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" type="submit" disabled="@(_isLoading)">
                                    Submit
                                </button>
                            *@
                            <button class="btn btn-secondary" type="button" @onclick="ResetForm">
                                Cancel
                            </button>
                            @if(_isLoading)
                            {
                                <button class="btn btn-primary" type="button" disabled>
                                    <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                    <span role="status">Loading...</span>
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-primary" type="submit" disabled="@(_isSuccessful && !_isLoading)">
                                    Submit
                                </button>
                            }
                        </div>
                    </EditForm>
                </div>
            </div>
            <div class="col-1">
            </div>
        </div>
    </div>
}

@code {

    //Models Operation Variables
    private UpdateCreatedTaskDto _updateCreatedTaskModel;
    private EditContext _editContext;
    private ValidationMessageStore _messageStore;
    private int _loggedInUserId;

    //Edit Operation Variables
    private bool _isLoading = false;
    private bool _isSuccessful;
    private string _responseMessage;

    //Get Task To Edit Variables
    private CreatedTaskDto? _taskToUpdate;
    private string _fetcTaskToUpdateResponseMessage;
    private bool _fetchTaskToUpdateSuccessStatus;
    private bool _isFetchingTaskToUpdate;

    [Parameter, EditorRequired]
    public string TaskId { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _loggedInUserId = int.Parse(user.FindFirst(x => x.Type.EndsWith("serialnumber"))?.Value ?? "0");

        await FetchTaskToUpdate();

        if(_taskToUpdate is null && !_fetchTaskToUpdateSuccessStatus)
        {
            return;
        }

        _updateCreatedTaskModel = new UpdateCreatedTaskDto() { Id = _taskToUpdate.Id, Description = _taskToUpdate.Description, ProposedCompletionDate = _taskToUpdate.ProposedCompletionDate.Date, Title = _taskToUpdate.Title, Priority = _taskToUpdate.Priority };

        _editContext = new EditContext(_updateCreatedTaskModel);
        _messageStore = new ValidationMessageStore(_editContext);

        _editContext.OnFieldChanged += (sender, args) =>
        {
            ValidateField(args.FieldIdentifier);
        };

        _editContext.OnValidationRequested += (sender, args) =>
       {
           _messageStore.Clear();
           ValidateAll();
           _editContext.NotifyValidationStateChanged();
       };
    }

    private async Task OnHandleSubmit()
    {
        _editContext.Validate(); 

        if (!_editContext.Validate())
        {
            return;
        } 

        _isLoading = true;

        //Add more custom rules here...
        var response = await editCreatedTaskHandler.Handle(_updateCreatedTaskModel);
        _isSuccessful = response.isSuccessful; _responseMessage = response.responseMessage;

        // await Task.Delay(5500);
        // _isSuccessful = DateTime.Now.Second % 2 == 0;
        // _responseMessage = _isSuccessful ? "Successful" : "Failed";

        _isLoading = false;

        if (_isSuccessful)
        {
            var authState = await authStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            _loggedInUserId = int.Parse(user.FindFirst(x => x.Type.EndsWith("serialnumber"))?.Value ?? "0");

            await FetchTaskToUpdate();

            if (_taskToUpdate is null && !_fetchTaskToUpdateSuccessStatus)
            {
                return;
            }

            _updateCreatedTaskModel = new UpdateCreatedTaskDto() { Id = _taskToUpdate.Id, Description = _taskToUpdate.Description, ProposedCompletionDate = _taskToUpdate.ProposedCompletionDate.Date, Title = _taskToUpdate.Title, Priority = _taskToUpdate.Priority };


            _editContext = new EditContext(_updateCreatedTaskModel);
            _messageStore = new ValidationMessageStore(_editContext);

        }

    }
    private async Task ResetForm()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _loggedInUserId = int.Parse(user.FindFirst(x => x.Type.EndsWith("serialnumber"))?.Value ?? "0");

        await FetchTaskToUpdate();

        if (_taskToUpdate is null && !_fetchTaskToUpdateSuccessStatus)
        {
            return;
        }

        _updateCreatedTaskModel = new UpdateCreatedTaskDto() { Id = _taskToUpdate.Id, Description = _taskToUpdate.Description, ProposedCompletionDate = _taskToUpdate.ProposedCompletionDate.Date, Title = _taskToUpdate.Title, Priority = _taskToUpdate.Priority };


        _editContext = new EditContext(_updateCreatedTaskModel);
        _messageStore = new ValidationMessageStore(_editContext);


        _isSuccessful = default;
        _isLoading = false;
        _responseMessage = null;
    }

    private void ValidateField(FieldIdentifier field)
    {
        _messageStore.Clear(field);

        if (field.FieldName == nameof(UpdateCreatedTaskDto.ProposedCompletionDate))
        {
            if (_updateCreatedTaskModel.ProposedCompletionDate <= DateTime.UtcNow.Date)
            {
                _messageStore.Add(field, "Expected delivery date must be in the future.");
            }
        }
    }

    private async Task FetchTaskToUpdate()
    {
        _isFetchingTaskToUpdate = true;
        var response = await getCreatedTaskByTaskIdHandler.Handle(TaskId);

        _fetchTaskToUpdateSuccessStatus = response.IsSuccessful;
        _fetcTaskToUpdateResponseMessage = response.Message;
        _taskToUpdate = response?.Data ?? null;
        _isFetchingTaskToUpdate = false;
    }

    private void ValidateAll()
    {
        // Example: validate date
        if (_updateCreatedTaskModel.ProposedCompletionDate <= DateTime.UtcNow.Date)
        {
            var field = new FieldIdentifier(_updateCreatedTaskModel, nameof(UpdateCreatedTaskDto.ProposedCompletionDate));
            _messageStore.Add(field, "Expected delivery date must be in the future.");
        }

        
    }

    private void HandleNavigateToList()
    {
        navManager.NavigateTo("tasks");
    }
}
