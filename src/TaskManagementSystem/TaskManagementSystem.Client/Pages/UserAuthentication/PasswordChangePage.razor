@page "/identity/change-password"
@layout CustomLayout


@if(_editContext is not null)
{
	<div class="container h-100 d-flex justify-content-center align-items-center">
		<div class="col-lg-4 col-md-6 col-sm-10">
			<div class="card shadow-sm rounded-4 p-4">
				<h3 class="text-center mb-4 fw-bold">Change Password</h3>

				<EditForm EditContext="_editContext" OnValidSubmit="HandlePasswordChange">
					<DataAnnotationsValidator />

					<!-- Email -->
					<div class="form-group my-3">
						<label class="form-label fw-bold" for="password-change-email">Email Address</label>
						<InputText @bind-Value="_passwordChangeDetails.Email"
								   id="password-change-email"
								   readonly="@_isFromStorage"
								   class="form-control" />
						<ValidationMessage For="() => _passwordChangeDetails.Email" />
					</div>

					<!-- Password -->
					<div class="form-group">

						<label class="form-label fw-bold" for="login-password">Password</label>

						<div class="input-group p-2">

							<InputText @bind-Value="_passwordChangeDetails.Password"
									   id="password-change-password"
									   class="form-control"
									   readonly="@_isFromStorage"
									   type="@PasswordInputType" />

							<button class="btn btn-outline-secondary"
									type="button"
									@onclick="TogglePassword"
									aria-label="Toggle password visibility">
								<i class="bi @(_showPassword ? "bi-eye-slash" : "bi-eye")"></i>
							</button>
						</div>
						<ValidationMessage For="() => _passwordChangeDetails.Password" />
					</div>

					<!-- NEW PASSWORD -->
					<div class="form-group">

						<label class="form-label fw-bold" for="password-change-new-password">New Password</label>

						<div class="input-group p-2">

							<InputText @bind-Value="_passwordChangeDetails.NewPassword"
									   id="password-change-new-password"
									   class="form-control"
									   type="@NewPasswordInputType" />

							<button class="btn btn-outline-secondary"
									type="button"
									@onclick="ToggleNewPassword"
									aria-label="Toggle password visibility">
								<i class="bi @(_showNewPassword ? "bi-eye-slash" : "bi-eye")"></i>
							</button>
						</div>
						<ValidationMessage For="() => _passwordChangeDetails.NewPassword" />
					</div>

					<!-- CONFIRM NEW PASSWORD -->
					<div class="form-group">

						<label class="form-label fw-bold" for="password-change-confirm-password">Confirm New Password</label>

						<div class="input-group p-2">

							<InputText @bind-Value="_passwordChangeDetails.ConfirmNewPassword"
									   id="password-change-confirm-password"
									   class="form-control"
									   type="@ConfirmNewPasswordInputType" />

							<button class="btn btn-outline-secondary"
									type="button"
									@onclick="ToggleConfirmNewPassword"
									aria-label="Toggle password visibility">
								<i class="bi @(_showConfirmNewPassword ? "bi-eye-slash" : "bi-eye")"></i>
							</button>
						</div>
						<ValidationMessage For="() => _passwordChangeDetails.ConfirmNewPassword" />
					</div>

					@if (_responseMessage is not null && !_isLoading && !_isSuccess)
					{
						<p class="text-danger alert mt-2 fst-italic fw-bold fs-6 text-center text-wrap">
							@_responseMessage
						</p>
					}

					<div class="mt-2">
						@if (_isLoading)
						{
							<button class="btn btn-primary w-100 rounded-3" type="button" disabled>
								<span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
								<span role="status">Loading...</span>
							</button>
						}
						else
						{
							<button type="submit" class="btn btn-primary w-100 rounded-3">
								Login
							</button>
						}

					</div>
				</EditForm>
			</div>
		</div>
	</div>
}


@code {

	private EditContext _editContext;
	private ChangeUserPasswordDto _passwordChangeDetails;
	private bool _isFromStorage = false;

	private string _responseMessage;
	private bool _isLoading = false;
	private bool _isSuccess;

	protected override async Task OnInitializedAsync()
	{
		await Task.Delay(500);
		UserToLoginDto? loggedInUser = await _localStorageService.GetItemAsync<UserToLoginDto>("UserToChangePassword") ?? null;

		if(loggedInUser is not null)
		{
			_isFromStorage = true;
			_passwordChangeDetails = new ChangeUserPasswordDto() { Email = loggedInUser.Email, Password = loggedInUser.Password };
		}
		else
		{
			_passwordChangeDetails = new();
		}

		_editContext = new EditContext(_passwordChangeDetails);
	}

	private async Task HandlePasswordChange()
	{
		_isLoading = true;
		//await Task.Delay(5000);
		var changePasswordResponse = await _changePasswordHandler.Handle(_passwordChangeDetails);
		_isSuccess = changePasswordResponse.isSuccess; _responseMessage = changePasswordResponse.message;
		_isLoading = false;
		if(_isSuccess)
		{
			_navManager.NavigateTo("identity/login");
		}
	}

	
}

@code {

	//Password Toggle Implementation
	private bool _showPassword = false;

	private string PasswordInputType => _showPassword ? "text" : "password";

	private void TogglePassword()
	{
		_showPassword = !_showPassword;
	}

	//New Password Toggle Implementation
	private bool _showNewPassword = false;

	private string NewPasswordInputType => _showNewPassword ? "text" : "password";

	private void ToggleNewPassword()
	{
		_showNewPassword = !_showNewPassword;
	}

	//New Password Toggle Implementation
	private bool _showConfirmNewPassword = false;

	private string ConfirmNewPasswordInputType => _showConfirmNewPassword ? "text" : "password";

	private void ToggleConfirmNewPassword()
	{
		_showConfirmNewPassword = !_showConfirmNewPassword;
	}
}
